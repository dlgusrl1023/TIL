# spot instance

---

## spot instance 란

* Amazon EC2 스팟 인스턴스는 온디맨드 요금과 비교해 저렴한 할인 가격으로 제공되는 AWS 클라우드의 예비 컴퓨팅 용량이다.
* 온디맨드 요금에서 최대 90%를 절약할 수 있다.
* 온디맨드 인스턴스와 스팟 인스턴스의 유일한 차이점은 EC2에서 용량을 되돌려야 할 때 2분 알림으로 EC2가 스팟 인스턴스를 중단시킬 수 있다는 것이다.
  
---

## spot instance 예시
  * 어떤 기업이 있는데, 그 기업의 웹사이트를 사용하는 사용자의 양이 아래와 같다고 하자.
  
  ![웹 사용량](http://www.mobizen.pe.kr/attach/1/cfile23.uf.17071C33504801370A9817.gif)
  
  * 위의 그래프를 보면 새벽 5시쯤에는 서버가 처리하는 양이 적기 때문에 작은 서버를 사용하면 되지만 굳이 18시에 처리하는 양을 커버하는 서버를 이용할 필요가 없다.
  * 이럴 경우 시간에 맞춰서 spot instance를 구입해서 사용하면 돈을 아낄 수 있다.
  
---

## spot instance 요청

---

### 요청 유형
  
1. 요청 - 일회용 스팟 요청. 일회성 요청을 생성하는 경우 필요한 요청을 수행하되, 용량이 줄어도 스팟 인스턴스를 보충하려 하지는 않는다.
1. 요청 및 유지 - 목표 용량 유지를 이 목표 용량을 충족하도록 요청을 수행하고 중단된 인스턴스를 자동으로 보충한다.
1. 기간 예약 - 특정 시간동안 중단 없이 스팟 인스턴스를 요청한다.
 
---

### AMI
  
* AMI는 인스턴스를 시작할 때 필요한 소프트웨어(OS, 애플리케이션 서버, 애플리캐이션)이 포함된 탬플릿이다.

---

### instance 유형
  
* instance 유형 선택에서는 모든 instance 유형, vCPUs개수, 메모리, 스토리지, 네트워크, 스팟 요금, 스팟 절감을 알 수 있습니다.

---

### 네트워크
  
* 인스턴스를 VPC로 시작하는데, 이때 VPC를 생성하고 IP주고 범위 선택하고, 서브넷을 생성하고, 라우팅 테이블을 구성하고, 네트워크 게이트웨이를 구성 할 수 있다.
 
> VPC : VPC는 Virtual Private Cloud의 약자로 아마존 클라우드 내에서 private ip를 사용하는 일종의 가상 private network 망을 만들어줄 수 있게 해주는 서비스이다.
        이 서비스 전에는 EIP 이외에는 정적 서비스를 사용할 수 없었으며, 또한 10.0.x.x와 같은 private ip를 사용할 수 없었다. VPC 서비스와 함께, 내부 ip 대역을 사용할 수 있게 되었으며
        조금 더 유연한 네트워크 관리가 가능하게 되었다. 

> Subnet : VPC를 생성했으면, 각각의 Subnet을 생성해야 한다. VPC안에는 여러개의 subnet을 생성 할 수 있는데, 하나의 subnet은 VPC안에서 하나의 AZ에만 생성 가능하다.

![single Region](https://t1.daumcdn.net/cfile/tistory/2563F7495210545818)

> Route Table : 각 subnet에는 default로 subnet과 밖을 연결해주는 router가 생성되고, 이 router는 route table을 가지고 있다. 
                대상 ip address에 routing 경로를 정의하는 것으로 subnet에서 밖으로 나가는 outbound traffic에 대한 routing 경로를 정의한다.
                이 route table은 AWS 콘솔에서 설정이 가능하다.


더 자세한 내용은 [링크](http://bcho.tistory.com/779)를 참고하자.

---

### 가용 영역
  
* 가용 영역은  region 이라하는 별개의 지리적 영역에 고유한 격리된 위치이다.
  스팟을 사용하면 특정 region 내에서 여러 가용 영역을 선택해서 spot instance를 사용할 수 있다.

---

### EBS 볼륨
  
* 크기(GiB)와 볼륨 유형을 조절 할 수 있다.

---

### 보안 그룹

* 보안 그룹은 인스턴스에 대한 트래픽을 제어하는 방화벽 규칙 세트이다.
* mysql, php-apach 연동 할 때에도 보안 그룹을 이용해서 포트를 열어주었다.

---

### 로드 밸런싱

---

#### 로드 밸런싱이란

* Elastic Load Balancing은 들어오는 애플리케이션 트래픽을 Amazon EC2 인스턴스, 컨테이너, IP 주소와 같은 여러 대상에 자동으로 분산시킨다.
  Elastic Load Balancing은 단일 가용 영역 또는 여러 가용 영역에서 다양한 애플리케이션 부하를 처리할 수 있다.
---

#### 로드 밸런싱 예시

1. 도메인을 로드 밸런스에 물리는 경우가 있다.
1. 도메인을 만들고, Alias Target에서 로드밸런스를 선택한다.
1. 로드밸런서 안에 인스턴스를 올릴 수 있다.
1. 도메인이 로드밸런서를 가리키고, 로드밸런서가 인스턴스를 분산한다.
1. 이때 스팟서버를 이용해서 분산 관리를 한다.
1. 한 서버는 메인으로 안정적인 서버를 이용하고, 스팟 서버를 쭉 붙이면 된다.

---

## spot instance 삭제

* 스팟 요청한 서버는 특별하게 없애야 한다.
* 스팟 요청으로 가서 인스턴스 id와 같은 것을 찾고 스팟 요청 취소를 하면 된다.
* 회살표를 눌렀을 때 아래에 나오는 것도 둘다 같이 선택해서 요청 취소 해야한다.
* 스팟은 '인스턴스 설정-> 종료방지' 가 아예 비활성화 되어있다.

---

## spot 중지

* spot을 사용하면 엄청 할인돼서 좋지만 서버가 사라질 수도 있다는 단점이 있다.
* spot이 중지할 것을 예방하기 위해서 이미지를 떠야 한다.
* 본인이 내릴 서버를 이미지 생성
* 서버 우클릭 -> 이미지 생성 클릭 -> 이름에 버전 달고 -> 이미지 생성 -> 생성 후 태그를 달아줌(AMI 이름)
* 이미지를 떠놓으면 서버를 생성 할 수 있음.
* 이미지를 뜰 때, 서버가 꺼짐
* **이미지로 뜬 서버는 ssh설정이 깨져있다.(아이디로 로그인 안되고, pem으로 접속만 됨)**
* 이미지로 뜨고 한 후 스냅샷까지 지워줘야한다.(스냅샷도 과금된다.)
* 이미지는 이미지 데몬에서 복사되지만 스냅샷은 하드디스크에 복사된다.





